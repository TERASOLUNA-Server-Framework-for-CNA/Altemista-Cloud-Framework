
:fragment:

In this section we will develop and build three microservices to maintain each of the application's entities like Users, Movies and Recommendations.

For each service, it is necessary to create a new *"ALTEMISTA Cloud Framework ({framework}) application"*. Choose a groupID (shared by all microservices) and the names for services. In this sample we chose _"org.altemista.cloudfwk.demo"_ as the groupID and _"AltemistaMoviesUsers"_, _"AltemistaMoviesMovies"_ and _"AltemistaMoviesRecommendations"_ for the applications name.

.New ALTEMISTA Cloud Framework ({framework}) application
image::altemista-cloudfwk-documentation/microservices/demo/06.Applications01.png[align="center"]

.Demo microservices. {framework} microservices application nature projects
[options="header"]
|===
^.^|Microservice name                                                                   |Application name / ArtifactId   |App. short ID            |GroupID                  
^.^|<<users-management-microservice,Users Management Microservice>>                     |AltemistaMoviesUsers           |altemistamoviesusers    |org.altemista.cloudfwk.demo 
^.^|<<movies-management-microservice,Movies Management Microservice>>                   |AltemistaMoviesMovies          |altemistamoviesmovies   |org.altemista.cloudfwk.demo 
^.^|<<recommendations-management-microservice,Recommendations Management Microservice>> |AltemistaMoviesRecommendations |altemistamoviesrecomend |org.altemista.cloudfwk.demo 
|=== 

On the next Screen ensure that the Aggregator type is *"{framework} microservices application nature"*. 

.{framework} microservices application nature aggregator type
image::altemista-cloudfwk-documentation/microservices/demo/06.Applications.png[align="center"]

Continue and add bussines module called `data` of type `Stand-alone implementation`

.{framework} Stand-alone implementation bussines module
image::altemista-cloudfwk-documentation/microservices/demo/07.AppBussinesModule.png[align="center"]

The application uses a HSQLDB as a database. The next step is adding the Persistence ORM Feature in `{application}-data-core module`.

.Adding {framework} Persistence ORM Feature
image::altemista-cloudfwk-documentation/microservices/demo/08.ORMFeatureDataModule.png[align="center"]

[IMPORTANT]
====
You must repeat <<_backend,this steps>> for each microservices to be implemented.

* AltemistaMoviesUsers
* AltemistaMoviesMovies
* AltemistaMoviesRecommendations
====

=== Persistence ORM Feature. Database initialization

By default, the Persistence ORM Feature configure an embedded database in `{application}-persistence-ds-env.xml` file.

This bean uses the .sql files on the application startup to configure and insert new data.

You can get the content of this files by microservices in the next paragraphs:

==== AltemistaMoviesUsers initialization scripts 

[source,sql]
./AltemistaMoviesUsers-env/src/main/resources/scripts/schema-jpa-env.sql
----
-- In-memory database
DROP TABLE PUBLIC.USER IF EXISTS;
CREATE MEMORY TABLE PUBLIC.USER(
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	BIRTHDATE BIGINT,
	EMAIL VARCHAR(255),
	FIRSTNAME VARCHAR(255),
	LASTNAME VARCHAR(255),
	PHONE VARCHAR(255)
);
ALTER TABLE PUBLIC.USER ALTER COLUMN ID RESTART WITH 1;
----

[source,sql]
./AltemistaMoviesUsers-env/src/main/resources/scripts/data-jpa-env.sql
----
INSERT INTO USER VALUES(1,NULL,'kevin.ross58@example.com','Kevin','Ross','(421)-117-4934')
INSERT INTO USER VALUES(2,NULL,'leonard.burke88@example.com','Leonard','Burke','(897)-609-6461')
INSERT INTO USER VALUES(3,NULL,'sebastian.hawkins53@example.com','Sebastian','Hawkins','(268)-398-4330')
INSERT INTO USER VALUES(4,NULL,'myrtle.west18@example.com','Myrtle','West','(471)-547-8646')
INSERT INTO USER VALUES(5,NULL,'jenny.fletcher42@example.com','Jenny','Fletcher','(753)-342-1844')
INSERT INTO USER VALUES(6,NULL,'willard.may54@example.com','Willard','May','(818)-817-8845')
INSERT INTO USER VALUES(7,NULL,'marvin.mccoy68@example.com','Marvin','Mccoy','(384)-361-6281')
----

==== AltemistaMoviesMovies initialization scripts 

[source,sql]
./AltemistaMoviesMovies-env/src/main/resources/scripts/schema-jpa-env.sql
----
-- In-memory database
DROP TABLE PUBLIC.MOVIE IF EXISTS;
CREATE MEMORY TABLE PUBLIC.MOVIE(
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	TITLE VARCHAR(255)
);
ALTER TABLE PUBLIC.MOVIE ALTER COLUMN ID RESTART WITH 1
----

[source,sql]
./AltemistaMoviesMovies-env/src/main/resources/scripts/data-jpa-env.sql
----
INSERT INTO MOVIE VALUES(1,'false','/bOGkgRGdhrBYJSLpXaxhXVstddV.jpg','en','Avengers: Infinity War','As the Avengers and their allies have continued to protect the world from threats too large for any one hero to handle, a new danger has emerged from the cosmic shadows: Thanos. A despot of intergalactic infamy, his goal is to collect all six Infinity Stones, artifacts of unimaginable power, and use them to inflict his twisted will on all of reality. Everything the Avengers have fought for has led up to this moment - the fate of Earth and existence itself has never been more uncertain.','577.421593','/7WsyChQLEftFiDOVTGkv3hFpyyt.jpg','2018-04-25','Avengers: Infinity War','false','8.5','3745')
INSERT INTO MOVIE VALUES(2,'false','/75RJi3yVZnZtVj4Kn1bYGzkhiEx.jpg','en','Dirty Dead Con Men','A cool and dangerous neo-noir crime film that revolves around the disturbed lives of two unlikely partners: Mickey Rady, a rogue undercover cop and Kook Packard, a smooth and charismatic con man. Together they rip off those operating outside of the law...for their own personal gain. But things go awry when one heist suck them deep into a city-wide conspiracy...','544.737128','/r70GGoZ5PqqokDDRnVfTN7PPDtJ.jpg','2018-03-30','Dirty Dead Con Men','false','2.9','8')
INSERT INTO MOVIE VALUES(3,'false','/9ywA15OAiwjSTvg3cBs9B7kOCBF.jpg','en','Fifty Shades Freed','Believing they have left behind shadowy figures from their past, newlyweds Christian and Ana fully embrace an inextricable connection and shared life of luxury. But just as she steps into her role as Mrs. Grey and he relaxes into an unfamiliar stability, new threats could jeopardize their happy ending before it even begins.','478.785894','/jjPJ4s3DWZZvI4vw8Xfi4Vqa1Q8.jpg','2018-02-07','Fifty Shades Freed','false','6','1863')
...
----

IMPORTANT: Download the entire link:resources/altemista-cloudfwk-documentation/demo/backend/moviesmicroservice/data-jpa-env.sql[data-jpa-env.sql]

==== AltemistaMoviesRecommendations initialization scripts

[source,sql]
./AltemistaMoviesRecommendations-env/src/main/resources/scripts/schema-jpa-env.sql
----
-- In-memory database
DROP TABLE PUBLIC.RECOMMENDATION IF EXISTS;
CREATE MEMORY TABLE PUBLIC.RECOMMENDATION(
	ID BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
	COMMENT VARCHAR(255) NOT NULL,
	MOVIEID BIGINT NOT NULL,
	USERID BIGINT NOT NULL
);
ALTER TABLE PUBLIC.RECOMMENDATION ALTER COLUMN ID RESTART WITH 1;
----

[source,sql]
./AltemistaMoviesRecommendations-env/src/main/resources/scripts/data-jpa-env.sql
----
INSERT INTO RECOMMENDATION VALUES(1,'Comment!!!',1,1)
INSERT INTO RECOMMENDATION VALUES(2,'Comment 2!!!',4,5)
INSERT INTO RECOMMENDATION VALUES(3,'Movie Comment 3!!!',3,1)
----

[NOTE]
====
If you like to configure a datasource you can see the <<hsqldb-configuration>> appendix.
====

//=== Spring Data REST Repositories 
//To expose the Spring Data REST Repositories endpoints have to add the `spring-boot-starter-data-rest` dependency in the `{application}-boot` module and configure the `jpa:repository` configuration. With persistence ORM Feature, the `jpa:repository` configuration must be added. As we used the plugin to add ORM Feature the jpa:repository was automatically configured.
//
//[source,xml]
//.{application}-boot/pom.xml
//----
//<dependency>
//  <groupId>org.springframework.boot</groupId>
//  <artifactId>spring-boot-starter-data-rest</artifactId>
//</dependency>
//----
//
//[source,xml]
//.{application}-data-core/src/main/resources/spring/{application}-data-core-persistence-jpa.xml
//----
//<?xml version="1.0" encoding="UTF-8"?>
//<beans xmlns="http://www.springframework.org/schema/beans"
//	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
//	xmlns:jpa="http://www.springframework.org/schema/data/jpa"
//	xsi:schemaLocation="
//		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
//		http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd">
//
//	<!-- Looks up Spring Data JPA repositories inside the package specified by the application -->
//	<jpa:repositories base-package="org.altemista.cloudfwk.demo.altemistamoviesusers.data.repository" transaction-manager-ref="jpaTransactionManager" /> <!--1-->
//	
//</beans>
//----
//<1> Valid repository package.

//NOTE: The JPA Repository scan can be added with the `@EnableJpaRepositories(basePackages = {"org.altemista.cloudfwk.demo.altemistamoviesusers.data.repository"})` annotation instead of `<jpa:repositories/>` definition tag.

[[users-management-microservice]]
=== Users management microservice

include::{basedir}/altemista-cloudfwk-core-microservices/demo/backend/usersmicroservice.adoc[]

[[movies-management-microservice]]
=== Movies management microservice

include::{basedir}/altemista-cloudfwk-core-microservices/demo/backend/moviesmicroservice.adoc[]

[[recommendations-management-microservice]]
=== Recommendations management microservice

include::{basedir}/altemista-cloudfwk-core-microservices/demo/backend/recommendationsmicroservice.adoc[]